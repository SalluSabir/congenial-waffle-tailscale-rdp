name: Tailscale Ubuntu Setup

on:
  workflow_dispatch:

jobs:
  secure-shell:
        # Change the runner to macOS
    runs-on: ubuntu-latest
        # Keep the long timeout
    timeout-minutes: 3600

        
    steps:
      - name: ‚¨áÔ∏è Install Tailscale on Ubuntu
        run: |
          # 1. Fetch and DEARmor the GPG key to a secure location
          # The key 458CA832957F5868 is the official Tailscale key.
          echo "Importing Tailscale GPG key..."
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.gpg | sudo gpg --dearmor -o /usr/share/keyrings/tailscale-archive-keyring.gpg
          
          # 2. Add the Tailscale repository using the specified keyring file
          echo "Adding Tailscale repository list..."
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/tailscale.list
      
          # 3. Update package lists and install Tailscale
          echo "Updating package lists and installing Tailscale..."
          sudo apt-get update
          sudo apt-get install -y tailscale
      
          # 4. Verify installation
          if command -v tailscale > /dev/null; then
            echo "‚úÖ Tailscale command line tool is now available."
          else
            echo "‚ùå Tailscale installation failed."
            exit 1
          fi

      # --- Tailscale Connection Steps ---

      - name: üîë Authenticate and Connect to Tailnet
        # This step starts the background service and then connects the node.
        run: |
          # 1. Start the Tailscale Daemon (tailscaled)
          echo "Starting Tailscale background service..."
          # 'sudo tailscaled' starts the main service.
          # The '&' runs it in the background, essential for CI.
          sudo tailscaled &
          
          # Give the service a moment to start up
          sleep 5 
          
          # 2. Authenticate and Connect
          echo "Authenticating and connecting to Tailnet..."
          
          # Use the full path for the command on macOS for absolute certainty (if needed)
          # On Ubuntu, 'tailscale' is in the PATH, but running the full path on macOS
          # ensures it works regardless of the previous $GITHUB_PATH setting.
          TS_COMMAND=$(command -v tailscale || echo "/Applications/Tailscale.app/Contents/MacOS/tailscale")
      
          sudo "$TS_COMMAND" up \
            --authkey ${{ secrets.TAILSCALE_AUTH_KEY }} \
            --accept-routes \
            --timeout 1m \
            --hostname github-runner-${{ matrix.os }}-${{ github.run_id }}
            
          # 3. Verify status
          echo "Tailscale connection status:"
          sudo "$TS_COMMAND" status
          
          # 4. Final Verification: Check the IP
          echo "Node IP address on Tailnet:"
          sudo "$TS_COMMAND" ip
        env:
          TS_NOGUI: "true" # Prevents GUI interaction on macOS

      # --- Verification/Test Step (Example) ---
      
      - name: üåê Verify Connectivity to a Tailnet Resource
        run: |
          # Replace 'some-node-name' or '100.x.x.x' with an actual node on your Tailnet
          # This is an example to show you can now access your private network
          echo "Pinging a private Tailnet IP (Example)..."
          echo "Address: $env:TAILSCALE_IP"
          ping -c 3 100.100.100.100 || true # Use an internal IP or node name
