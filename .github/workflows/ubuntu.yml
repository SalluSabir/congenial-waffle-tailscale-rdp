name: Tailscale Ubuntu Setup

on:
  workflow_dispatch:

jobs:
  secure-shell:
        # Change the runner to macOS
    runs-on: ubuntu-latest
        # Keep the long timeout
    timeout-minutes: 3600

        
    steps:
      - name: ‚¨áÔ∏è Install Tailscale on Ubuntu
        run: |
          # 1. Fetch and DEARmor the GPG key to a secure location
          # The key 458CA832957F5868 is the official Tailscale key.
          echo "Importing Tailscale GPG key..."
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.gpg | sudo gpg --dearmor -o /usr/share/keyrings/tailscale-archive-keyring.gpg
          
          # 2. Add the Tailscale repository using the specified keyring file
          echo "Adding Tailscale repository list..."
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/tailscale.list
      
          # 3. Update package lists and install Tailscale
          echo "Updating package lists and installing Tailscale..."
          sudo apt-get update
          sudo apt-get install -y tailscale
      
          # 4. Verify installation
          if command -v tailscale > /dev/null; then
            echo "‚úÖ Tailscale command line tool is now available."
          else
            echo "‚ùå Tailscale installation failed."
            exit 1
          fi

      # --- Tailscale Connection Steps ---

      - name: üîë Authenticate and Connect to Tailnet
        # This step runs on both macOS and Linux, as 'tailscale' is now in the PATH.
        run: |
          echo "Authenticating and connecting to Tailnet..."
          # Use an ephemeral authentication key and disable automatic DNS configuration.
          sudo tailscale up \
            --authkey ${{ secrets.TAILSCALE_AUTH_KEY }} \
            --accept-dns=false \
            --timeout 1m
            
          echo "Tailscale connection status:"
          tailscale status
        env:
          TS_NOGUI: "true" # Required for macOS to prevent GUI dialogs

      # --- Verification/Test Step (Example) ---
      
      - name: üåê Verify Connectivity to a Tailnet Resource
        run: |
          # Replace 'some-node-name' or '100.x.x.x' with an actual node on your Tailnet
          # This is an example to show you can now access your private network
          echo "Pinging a private Tailnet IP (Example)..."
          ping -c 3 100.100.100.100 || true # Use an internal IP or node name
