name: Secure VNC (Screen Sharing)

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    # Use macOS runner
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: ⚠️ Warning - Security Disclaimer
        run: |
          echo "=========================================================================="
          echo "WARNING: Enabling Screen Sharing on a public GitHub runner should be done"
          echo "with caution. This script relies on Tailscale for a private connection."
          echo "=========================================================================="

      - name: Configure VNC/Screen Sharing Service
        run: |
          # 1. Enable Screen Sharing (VNC) Service
          # Use the 'launchctl' command to load the screen sharing daemon.
          # The -w flag means 'write to plist' and makes the change persistent.
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          echo "Screen Sharing service enabled."

          # 2. Configure VNC Access (using a VNC password)
          # Note: The macOS runner might be headless or not fully support this step.
          # The standard GitHub Actions 'runner' user is used.
          # We'll try to set a VNC password, but this can fail on ephemeral/headless runners.
          # You will likely need to rely on Tailscale's network security only.
          
          # This command sets the VNC password, replacing 'YOUR_VNC_PASSWORD'
          # You MUST replace 'YOUR_VNC_PASSWORD' with a secure secret or generated password.
          # The 'runner' user's password must also be known or set.
          
          # *** For simplicity and reliability in the ephemeral runner environment, 
          # *** we will skip setting the VNC password and rely ONLY on Tailscale's authentication.
          # *** This means access is ONLY possible from a device connected to your Tailnet.

      - name: Create Secure Password and Output VNC Info
        run: |
          # Generate a strong password (for informational purposes/testing)
          echo "Generating a strong password for potential VNC use..."
          PASSWORD=$(python3 -c "import random, string; chars = string.ascii_letters + string.digits + string.punctuation; print(''.join(random.choice(chars) for i in range(16)))")
          
          # Since setting the 'runner' user password is unreliable, we just save the credentials info.
          echo "VNC_CREDS=User: runner | Password: <Tailscale Network Authentication Only>" >> $GITHUB_ENV
          
          # Note: This is NOT the VNC password, it's just a generated string.
          echo "Generated Password (NOT USED for VNC): $PASSWORD" 

      - name: Install Tailscale
        run: |
          # Download and install Tailscale binaries
          TS_VERSION="1.82.0"
          curl -fsSL "https://pkgs.tailscale.com/stable/tailscale-darwin-amd64-$TS_VERSION.tgz" -o tailscale.tgz
          tar -xzf tailscale.tgz
          sudo mv tailscale/tailscale /usr/local/bin/
          sudo mv tailscale/tailscaled /usr/local/bin/
          
          # Start the Tailscale daemon
          sudo tailscaled &

      - name: Establish Tailscale Connection
        run: |
          # Bring up Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$GITHUB_RUN_ID
          
          # Wait for Tailscale to assign an IP
          TS_IP=""
          RETRY_COUNT=0
          while [ -z "$TS_IP" ] && [ "$RETRY_COUNT" -lt 10 ]; do
              TS_IP=$(tailscale ip -4)
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT+1))
          done
          
          if [ -z "$TS_IP" ]; then
              echo "Tailscale IP not assigned. Exiting."
              exit 1
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
      
      - name: Verify VNC Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # VNC/Screen Sharing uses port 5900
          if ! nc -z -w 5 "$TAILSCALE_IP" 5900; then
              echo "TCP connection to VNC port 5900 failed"
              # NOTE: This failure might occur if the service isn't fully ready, 
              # but the workflow will continue to the 'Maintain Connection' step.
              # Don't exit here unless absolutely necessary.
          fi
          echo "TCP connectivity test complete!"

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== VNC (Screen Sharing) ACCESS ==="
          echo "Connect to: vnc://$TAILSCALE_IP"
          echo "Use your Tailscale-connected machine to access this IP."
          echo "Username: runner"
          echo "Password: (Authentication relies on Tailscale/macOS login)"
          echo "==================================="
          echo ""
          
          # Keep runner active
          while true; do
              echo "[$(date)] VNC Active - Use Ctrl+C in workflow to terminate"
              sleep 300
          done
